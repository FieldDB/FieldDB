name: Node.js CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [25.x]
    env:
      TZ: Canada/Eastern
      TIMEOUT: 1000
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Configure FieldDB version
        run: echo n | bash scripts/set_fielddb_version.sh

      - name: Install dependencies
        run: |
          npm ci || npm install
          npm install d3@3.5.8 jsdom@7.0.2 memory

      - name: Build (CI)
        run: npm run build:ci

      - name: Test e2e
        working-directory: test-e2e
        env:
          DEBUG: browser*
        run: |
          npm install
          npx playwright install chromium firefox webkit
          npm run lint ||  echo "lint errored skipping until we update it"
          DEBUG=server npm test
      - name: Upload Playwright report and traces for trace.playwright.dev 
        uses: actions/upload-artifact@v5
        if: ${{ !cancelled() }} # Upload even if the previous step failed
        with:
          name: test-results # Name of the artifact
          path: test-e2e/test-results/ # Path to the directory containing reports and traces
          retention-days: 30
  # Optional: deploy or after-success steps can be added as a separate job
  # deploy_spreadsheet:
  #   needs: build-and-test
  #   if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v6
  #     - name: Upload artifacts to server
  #       env:
  #         USERNAME: ${{ secrets.PUBLISH_SPREADSHEET_USERNAME }}
  #         PASSWORD: ${{ secrets.PUBLISH_SPREADSHEET_PASSWORD }}
  #         SERVER: ${{ secrets.PUBLISH_SPREADSHEET_SERVER }}
  #       run: |
  #         touch "angular_client/modules/spreadsheet/dist/deployed at $(date)"
  #         NOW=$(date)
  #         sed "s/(appVersion = \"[^,]*ss\")/\1 $NOW\"/" angular_client/modules/spreadsheet/dist/scripts/scripts.js > output
  #         mv output angular_client/modules/spreadsheet/dist/scripts/scripts.js
  #         ncftpput -R -v -u "$PUBLISH_SPREADSHEET_USERNAME" -p "$PUBLISH_SPREADSHEET_PASSWORD" "$PUBLISH_SPREADSHEET_SERVER" / angular_client/modules/spreadsheet/dist/*
